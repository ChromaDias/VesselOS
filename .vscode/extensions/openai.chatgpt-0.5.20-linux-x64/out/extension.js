"use strict";var jo=Object.create;var pe=Object.defineProperty;var zo=Object.getOwnPropertyDescriptor;var Ko=Object.getOwnPropertyNames;var Jo=Object.getPrototypeOf,Xo=Object.prototype.hasOwnProperty;var P=(s,e)=>()=>(s&&(e=s(s=0)),e);var ot=(s,e)=>{for(var t in e)pe(s,t,{get:e[t],enumerable:!0})},st=(s,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ko(e))!Xo.call(s,n)&&n!==t&&pe(s,n,{get:()=>e[n],enumerable:!(o=zo(e,n))||o.enumerable});return s};var m=(s,e,t)=>(t=s!=null?jo(Jo(s)):{},st(e||!s||!s.__esModule?pe(t,"default",{value:s,enumerable:!0}):t,s)),Qo=s=>st(pe({},"__esModule",{value:!0}),s);function k(){return ct.workspace.getConfiguration("chatgpt")}var ct,dt,pt,z=P(()=>{"use strict";ct=m(require("vscode")),dt="apiEndpoint",pt="logLevel"});var ue=P(()=>{"use strict"});function fe(s){return lt[s]<=lt[os]}function ss(){let s=ut.window.createOutputChannel("Codex",{log:!0});return{trace:(t,...o)=>{fe("trace")&&s.trace(t,...o)},debug:(t,...o)=>{fe("debug")&&s.debug(t,...o)},info:(t,...o)=>{fe("info")&&s.info(t,...o)},error:(t,...o)=>{s.error(t,...o)},warn:(t,...o)=>{fe("warning")&&s.warn(t,...o)},dispose:()=>s.dispose()}}var ut,ts,os,lt,d,R=P(()=>{"use strict";z();ue();ut=m(require("vscode")),ts="warning",os=k().get(pt)??ts,lt={error:0,warning:1,info:2,debug:3,trace:4};d=ss()});function Ht(s){return Object.prototype.hasOwnProperty.call(Oe,s)?s:null}var Bt,Q,Oe,Gt,jt,zt,re,Kt,Jt,Xt,Qt,Yt,B=P(()=>{"use strict";Bt=require("crypto"),Q=m(require("vscode")),Oe={content:{category:"queryGet",version:1},ping:{category:"queryGet",version:1},selections:{category:"queryGet",version:1},reload:{category:"queryGet",version:1},markForReload:{category:"queryPost",version:1},removeHighlights:{category:"mutationPost",version:1},highlightLines:{category:"mutationPost",version:1},highlight:{category:"mutationPost",version:1},setContent:{category:"mutationPost",version:1},replaceSelection:{category:"mutationPost",version:1}},Gt=Object.fromEntries(Object.entries(Oe).map(([s,e])=>[s,e.version]));jt=`oai_pwai ${Q.env.appName}`,zt=Q.workspace.name??Q.env.appName,re=Q.env.appName+"-"+(0,Bt.randomUUID)(),Kt="com.microsoft.VSCode",Jt="com.microsoft.VSCodeInsiders",Xt="com.vscodium",Qt="com.todesktop.230313mzl4w4u92",Yt="com.exafunction.windsurf"});function W(s){return Je().find(o=>o.document.fileName===s)||null}function eo(){return Je().map((e,t)=>{let o=e.selection.isEmpty?null:e.document.getText(e.selection),n=e.selection.isEmpty?null:e.selection.start.line;return o!=null&&n!=null?{selectedText:o,selectionLine:n}:null}).filter(e=>!!e)}function to(){return Je().map((e,t)=>{let o=e.document.getText(),n=e.document.fileName,r=e.selection.isEmpty?null:e.document.getText(e.selection),i=e.document.offsetAt(e.selection.start),a=e.document.offsetAt(e.selection.end),c=e.selection.isEmpty?null:e.selection.start.line,p=e.selection.isEmpty?null:{location:i,length:a-i};return r===o&&(r=null),{id:n,content:o,filename:n,selectedText:r,selectionRange:p,selectionLine:c}}).filter(e=>!!e)}function Je(){return Zt.window.visibleTextEditors.filter(e=>e.viewColumn!==void 0)}var Zt,De=P(()=>{"use strict";Zt=m(require("vscode"))});function _(s){throw new Error(`No editor for id ${s} found`)}var Xe=P(()=>{"use strict"});async function oo(s,e){let t=W(e);t||_(e);let o=t.document,n=new Y.Range(o.positionAt(0),o.positionAt(o.getText().length));await t.edit(i=>{i.replace(n,s)});let r=t.document.positionAt(s.length);t.selection=new Y.Selection(r,r)}async function so(s,e){let t=W(e);t||_(e);let o=t.selection,n=new Y.Range(o.start,o.end);await t.edit(r=>{r.replace(n,s)}),t.selection=new Y.Selection(n.start,n.start)}var Y,no=P(()=>{"use strict";De();Xe();Y=m(require("vscode"))});async function io(s,e){let t=W(e);t||_(e);let o=s.map(n=>{let r=new A.Range(n,0,n,t.document.lineAt(n).range.end.character);return ao(r,e)});await Promise.all(o)}function Ns(s){return new Promise(e=>setTimeout(e,s))}async function ao(s,e){let t=W(e);t||_(e),t.revealRange(s,A.TextEditorRevealType.InCenterIfOutsideViewport);let o=A.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${ro})`,isWholeLine:!0});t.setDecorations(o,[s]);let n=A.workspace.onDidChangeTextDocument(r=>{r.document===t.document&&(o.dispose(),G[e]=[],n.dispose())});G[e]||(G[e]=[]),G[e].push({range:s,decoration:o})}async function co(s,e){let t=W(s);t||_(s),ie[s]||(ie[s]=1);let o=++ie[s];if(e){let i=(G[s]||[]).map(async a=>{let c=a.decoration,p=10,h=500/p;try{for(let u=0;u<=p&&o===ie[s];u++){let g=u/p,v=ro*(1-g),S=A.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${v})`,isWholeLine:!0});t.setDecorations(S,[a.range]),c?.dispose(),c=S,await Ns(h)}}finally{c?.dispose()}});await Promise.all(i)}let n=G[s];n&&o===ie[s]&&(n.forEach(r=>r.decoration.dispose()),delete G[s])}async function po(s,e,t){let o=W(t);o||_(t);let n=Os(s,e,o.document);n&&await ao(n,t)}function Os(s,e,t){let o=0,n=0,r=0,i=0,a=0;for(let c=0;c<t.lineCount;c++){let l=t.lineAt(c).text.length+1;if(o<=s&&o+l>s&&(n=c,i=s-o),o<=e&&o+l>e){r=c,a=e-o;break}o+=l}if(n>=0&&r>=0){let c=new A.Position(n,i),p=new A.Position(r,a);return new A.Range(c,p)}return null}var A,G,ie,ro,lo=P(()=>{"use strict";De();Xe();A=m(require("vscode")),G={},ie={},ro=.2});async function mo(s,e){switch(s){case"removeHighlights":try{let{textfieldID:t,animated:o}=e;return await co(t,o),{status:"success",message:"Removed highlight"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlightLines":try{let{lines:t,textfieldID:o}=e;return await io(t,o),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlight":try{let{startChar:t,endChar:o,textfieldID:n}=e;return await po(t,o,n),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"setContent":try{let{content:t,textfieldID:o}=e;return await oo(t,o),{status:"success",message:"Set content successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"replaceSelection":try{let{content:t,textfieldID:o}=e;return await so(t,o),{status:"success",message:"Replaced selection successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}}}var ho=P(()=>{"use strict";B();no();lo()});async function go(s,e){let t=Buffer.alloc(0),o=null;s.on("data",async n=>{if(t=Buffer.concat([t,n]),o==null&&t.length>=4&&(o=t.readUInt32LE(0),t=t.subarray(4)),o!=null&&t.length>=o){let r=t.subarray(0,o).toString();t=t.subarray(o),o=null,await e(s,r)}}),s.on("end",()=>{d.debug("Desktop bridge: client disconnected")}),s.on("error",n=>{d.error("Desktop bridge socket error:",n)})}function ae(s,e){let t=JSON.stringify(e),o=Buffer.alloc(4),n=Buffer.byteLength(t);o.writeUInt32LE(n,0);let r=Buffer.from(t,"utf-8");s.write(o),s.write(r),s.end()}var Qe=P(()=>{"use strict";R()});function Ye(){return We.join(yo.homedir(),"Library","Application Support","com.openai.chat","app_pairing_extensions",re)}function Fs(s){let e=Ye();if(x.existsSync(e)){let t=x.watch(e,o=>{x.existsSync(e)||(s(),t.close())})}else d.warn("Desktop bridge: session path does not exist, cannot watch file.")}var x,vo,yo,We,Fe,wo=P(()=>{"use strict";R();B();Qe();x=m(require("fs")),vo=m(require("net")),yo=m(require("os")),We=m(require("path"));Fe=class{getSessionSocketPath(){return`/tmp/${re}.sock`}async deregister(){let e=Ye();d.info("Desktop bridge deregister",e),x.existsSync(e)&&x.unlinkSync(e),x.existsSync(this.getSessionSocketPath())&&x.unlinkSync(this.getSessionSocketPath())}async register(e,t){let o=Ye(),n=We.dirname(o);x.existsSync(n)||x.mkdirSync(n,{recursive:!0}),x.writeFileSync(o,JSON.stringify(e),"utf8"),d.info(`Desktop bridge wrote payload to ${o}`);let r=this.getSessionSocketPath();x.existsSync(r)?x.chmodSync(r,384):d.warn("Desktop bridge: socket file does not exist"),Fs(t)}startServer(e,t){let o=this.getSessionSocketPath();x.existsSync(o)&&x.unlinkSync(o);let n=vo.createServer(r=>{d.debug("Desktop bridge: client connected"),go(r,t)});n.listen(o,()=>{d.info(`Desktop bridge listening on UNIX socket: ${o}`)}),e.subscriptions.push({dispose:()=>{n.close(),this.deregister()}})}}});function Ws(){if(bo.platform()!=="darwin")throw new Error("Unsupported platform");return new Fe}var bo,H,Ze=P(()=>{"use strict";wo();bo=m(require("os"));H=Ws()});function Co(){switch(xo.env.appName){case"Visual Studio Code":return Kt;case"Visual Studio Code - Insiders":return Jt;case"VSCodium":return Xt;case"Cursor":return Qt;case"Windsurf":return Yt;default:return null}}var xo,Po=P(()=>{"use strict";B();xo=m(require("vscode"))});var _s,ce,et=P(()=>{"use strict";_s="0.0.1731016154",ce={name:"openai.chatgpt",version:_s,isInstalled:!0}});function So(s){Ro=s,H.deregister(),_e()}function _e(){let s=Co();if(!s)return;let e=H.getSessionSocketPath(),t={appName:L.env.appName,bundleID:s,extensionVersion:ce.version,marketplaceID:ce.name,extensionName:jt,workspaceName:zt,id:re,capabilities:Gt,needsReload:Ro,socketPath:e,timestamp:Date.now()};H.register(t,()=>{let o=L.l10n.t("Reregister"),n=L.l10n.t("Dismiss");L.window.showWarningMessage(L.l10n.t("The ChatGPT extension cannot find its registration file"),o,n).then(r=>{r===o&&_e()})})}var L,Ro,tt=P(()=>{"use strict";Po();B();Ze();et();L=m(require("vscode")),Ro=!1});function ko(s){switch(s){case"ping":{let{name:e,version:t}=ce;return{status:"success",version:t,name:e}}case"content":{let e=to();return e!=null?{status:"success",textfields:e}:{status:400,error:"No active editor found"}}case"selections":{let e=eo();return e!=null?{status:"success",selections:e}:{status:400,error:"No active editor found"}}case"reload":return Eo.commands.executeCommand("workbench.action.reloadWindow"),{status:"success"}}}async function To(s){switch(s){case"markForReload":return So(!0),{status:"success",message:"Marked for reload"}}}var Eo,Ao=P(()=>{"use strict";B();De();tt();et();Eo=m(require("vscode"))});var Oo={};ot(Oo,{activate:()=>qs,deactivate:()=>Us,respondToCompleteMessage:()=>No});function qs(s){Ls==="darwin"&&(d.info("ChatGPT desktop bridge active"),H.startServer(s,No),_e(),d.info("Desktop bridge registered"))}function Us(){H.deregister()}async function No(s,e){try{let t=JSON.parse(e),o=Ht(t.command);if(!o){ae(s,{status:404,error:"Unknown endpoint"});return}if(!Mo.workspace.isTrusted&&o!=="ping"){d.warn("Desktop bridge: untrusted workspace"),ae(s,{status:405,error:"The workspace must be trusted for the extension to read content."});return}let n=await $s(o,t.payload);n.status===400&&d.error("Desktop bridge error for command:",t.command),ae(s,n)}catch(t){d.error("Desktop bridge: error processing message:",t),ae(s,{success:!1,error:"Error handling message"})}}async function $s(s,e){let{category:t}=Oe[s];switch(t){case"queryGet":return ko(s);case"queryPost":return To(s);case"mutationPost":return mo(s,e)}}var Io,Mo,Ls,Do=P(()=>{"use strict";B();ho();Ze();Ao();tt();Qe();R();Io=m(require("os")),Mo=m(require("vscode")),Ls=Io.platform()});var Gs={};ot(Gs,{activate:()=>Bs});module.exports=Qo(Gs);var nt=m(require("path")),le=m(require("vscode"));function rt(s){let e=le.window.activeTextEditor;if(!e)return;let t=e.document.uri;if(t.scheme!=="file")return;let o=e.selection.start.line+1,n=e.selection.end.line+1;e.selection.end.character===0&&e.selection.end.line>e.selection.start.line&&n--;let r=t.fsPath,i=nt.basename(r),a=o!=null?`${i}:${o}`+(n!=null&&n!==o?`:${n}`:""):i;s.addContextFile({label:a,path:le.workspace.asRelativePath(r),fsPath:r,startLine:o,endLine:n})}var it=require("crypto"),qe=class s{constructor(e){this.mcpConnection=e;let t=this.mcpConnection.registerProvider(s.providerName,{onNotification:o=>this.handleNotification(o),onResult:o=>this.handleResult(o)});this.disposables.push(t)}static providerName="auth";disposables=[];pending=new Map;async getToken({refreshToken:e}){let t=(0,it.randomUUID)(),o=new Promise((n,r)=>{this.pending.set(t,{resolve:n,reject:r})});return this.mcpConnection.sendRequest(s.providerName,t,"getAuthStatus",{includeToken:!0,refreshToken:e}),o}resolve(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.resolve(t))}reject(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.reject(t))}handleResult(e){if(typeof e.id!="string")return;if(e.error){this.reject(e.id,e.error);return}let t=e.result??null;this.resolve(e.id,t?.authToken??null)}handleNotification(e){e.method==="codex/event/auth_status_change"&&this.getToken({refreshToken:!1})}dispose(){for(let e of this.disposables)e.dispose();this.disposables.length=0,this.pending.clear()}};function at(s){return new qe(s)}z();z();var Yo="http://localhost:8000/api",Zo="https://chatgpt.com/backend-api";function es(){switch(k().get(dt)){case"localhost":return Yo;case"production":default:return Zo}}function Ue(s){return s.startsWith("data:")||s.startsWith("http")?s:`${es()}/${s.replace(/^\//,"")}`}R();function ns(s){let e=s.split(/\r?\n/),t,o=[];for(let r of e)r.startsWith("event:")?t=r.slice(6).trim():r.startsWith("data:")&&o.push(r.slice(5).trim());if(o.length===0)return null;let n=o.join(`
`);try{return{event:t,data:JSON.parse(n)}}catch{return null}}function rs(s){let e=s.indexOf(`\r
\r
`),t=s.indexOf(`

`);return e===-1&&t===-1?[-1,0]:e===-1?[t,2]:t===-1?[e,4]:e<t?[e,4]:[t,2]}function is(s,e){return{async next(){if(e.aborted)return{done:!0,value:void 0};let{value:t,done:o}=await s.read();return o||t==null?{done:!0,value:void 0}:{done:!1,value:t}},[Symbol.asyncIterator](){return this}}}async function*ft(s,e){let t=s.getReader(),o=new TextDecoder,n="",r=is(t,e);try{for await(let i of r){n+=o.decode(i,{stream:!0});let a,c;for(;[a,c]=rs(n),a>=0;){let p=n.slice(0,a);n=n.slice(a+c);let l=ns(p);!l||l.event==="heartbeat"||(yield l)}}}finally{t.releaseLock()}}function mt(s){return!!s&&typeof s=="object"&&s.name==="AbortError"}function te(s){return new Promise(e=>setTimeout(e,s))}var he="codex_vscode",ht="vscode://codex/",K=3,as=300,cs=2e3,me=class{constructor(e,t,o){this.authProvider=e;this.extensionFetchHandler=t;this.userAgentProvider=o}abortSignals=new Map;streamControllers=new Map;shouldRetryStatus(e){return e===408||e===425||e===429||e>=500&&e<=599}backoffDelay(e){let t=Math.min(cs,as*2**e),o=t*.2*(Math.random()-.5)*2;return Math.max(0,Math.floor(t+o))}buildHeaders(e,t,o){let n={...e??{}},r=a=>Object.keys(n).some(c=>c.toLowerCase()===a);if(o.attachAuth&&t&&!r("authorization")){n.Authorization=`Bearer ${t}`;try{let a=JSON.parse(Buffer.from(t.split(".")[1],"base64url").toString("utf8"))["https://api.openai.com/auth"]?.chatgpt_account_id;a&&(n["ChatGPT-Account-Id"]=a)}catch{}}o.method!=="GET"&&!r("content-type")&&(n["Content-Type"]="application/json"),r("originator")||(n.originator=he);let i=this.userAgentProvider.getUserAgent();return i&&!r("user-agent")&&(n["User-Agent"]=i),n}shouldAttachAuth(e){let o=new URL(e).host.toLowerCase();return o==="localhost:8000"||o==="localhost"||o.endsWith(".openai.com")||o==="openai.com"||o==="chatgpt.com"||o.endsWith(".chatgpt.com")&&!o.startsWith("ab.")}async fetch(e){try{let t=new AbortController;if(this.abortSignals.set(e.requestId,t),t.signal.addEventListener("abort",()=>({type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499})),e.url.startsWith(ht)){let a=await this.extensionFetchHandler.handleVSCodeRequest(e.url.slice(ht.length),e.body?JSON.parse(e.body):void 0);return{type:"fetch-response",responseType:"success",requestId:e.requestId,status:200,headers:{},bodyJsonString:JSON.stringify(a)}}let o=Ue(e.url),n=await this.authProvider.getToken({refreshToken:!1}),r=this.shouldAttachAuth(o),i=async(a,c)=>{if(r&&!ds(c))return{type:"fetch-response",responseType:"error",requestId:e.requestId,status:401,error:`Cannot fetch ${e.url} without ChatGPT auth.`};let p=this.buildHeaders(e.headers,c,{method:e.method,attachAuth:r}),l=Object.keys(p).some(h=>h.toLowerCase()==="authorization");try{let h=e.body,u=Object.keys(p).find(E=>E.toLowerCase()==="x-codex-base64");if(u&&p[u]==="1"){if(e.body)try{h=Buffer.from(e.body,"base64")}catch{h=e.body}delete p[u]}let v=await fetch(o,{method:e.method,headers:p,body:h,signal:t.signal});if(v.status>=200&&v.status<300){let E=v.headers.get("content-type")||"",Z;if(E.includes("application/json")){let q=await v.json();Z=JSON.stringify(q)}else{let q=await v.arrayBuffer(),j=Buffer.from(q).toString("base64");Z=JSON.stringify({base64:j,contentType:E})}this.abortSignals.delete(e.requestId);let de={};return v.headers.forEach((q,j)=>{j!=="authorization"&&(de[j]=q)}),{type:"fetch-response",responseType:"success",requestId:e.requestId,status:v.status,headers:de,bodyJsonString:Z}}if(v.status===401&&l&&a<K){let E=await this.authProvider.getToken({refreshToken:!0});if(E&&E!==c)return i(a+1,E)}if(this.shouldRetryStatus(v.status)&&a<K){let E=this.backoffDelay(a);return await te(E),i(a+1,c)}let S=v.headers.get("cf-ray");return v.status===404?d.info(`Error fetching ${e.url}: ${v.status} ${v.statusText} (${S})`):d.error(`Error fetching ${e.url}: ${v.status} ${v.statusText} (${S})`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:v.status,error:v.statusText}}catch(h){if(t.signal.aborted)return{type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499};if(a<K){let u=this.backoffDelay(a);return await te(u),i(a+1,c)}return d.error(`Error fetching ${e.url}: ${String(h)}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:h instanceof Error?h.message:"Unknown error"}}};return i(0,n)}catch(t){return d.error(`Error fetching ${e.url}: ${t}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:t instanceof Error?t.message:"Unknown error"}}finally{this.abortSignals.delete(e.requestId)}}async stream(e,t){let o=new AbortController;this.streamControllers.set(e.requestId,o);let n=Ue(e.url),r=await this.authProvider.getToken({refreshToken:!1}),i=this.shouldAttachAuth(n),a=async(c,p)=>{let l=this.buildHeaders(e.headers,p,{method:e.method,attachAuth:i}),h=Object.keys(l).some(u=>u.toLowerCase()==="authorization");try{let u=await fetch(n,{method:e.method,headers:l,body:e.body,signal:o.signal});if(u.status===200&&u.body!=null){for await(let g of ft(u.body,o.signal))t({type:"fetch-stream-event",requestId:e.requestId,event:g.event,data:g.data});t({type:"fetch-stream-complete",requestId:e.requestId});return}if(u.status===401&&h&&c<K){let g=await this.authProvider.getToken({refreshToken:!0});if(g&&g!==p){await a(c+1,g);return}}if(this.shouldRetryStatus(u.status)&&c<K){let g=this.backoffDelay(c);await te(g),await a(c+1,p);return}t({type:"fetch-stream-error",requestId:e.requestId,error:`${u.status} ${u.statusText}`})}catch(u){if(o.signal.aborted||mt(u)){t({type:"fetch-stream-complete",requestId:e.requestId});return}if(c<K){let g=this.backoffDelay(c);await te(g),await a(c+1,p);return}t({type:"fetch-stream-error",requestId:e.requestId,error:u instanceof Error?u.message:"Unknown error"})}};try{await a(0,r)}finally{this.streamControllers.delete(e.requestId)}}cancel(e){let t=this.abortSignals.get(e);t&&(t.abort(),this.abortSignals.delete(e))}cancelStream(e){let t=this.streamControllers.get(e);t&&(t.abort(),this.streamControllers.delete(e))}};function ds(s){return s?/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(s):!1}ue();function oe(){if(!0){let{platform:s,arch:e}=process,t,o;switch(s){case"win32":t="windows";break;case"darwin":t="macos";break;case"aix":case"android":case"freebsd":case"haiku":case"linux":case"openbsd":case"sunos":case"cygwin":case"netbsd":t="linux";break}switch(e){case"x64":o="x86_64";break;case"arm64":o="aarch64";break;case"arm":case"ia32":case"loong64":case"mips":case"mipsel":case"ppc64":case"riscv64":case"s390x":throw new Error(`unrecognized architecture: ${e}`)}return`bin/${`${t}-${o}`}`}return"bin"}R();var gt=require("child_process");var U={CLI_EXECUTABLE:"cliExecutable",COMMENT_CODELENS_ENABLED:"commentCodeLensEnabled",OPEN_ON_STARTUP:"openOnStartup"};var se={HAS_PROBABLY_SEEN_2025_08_27_NUX:"hasProbablySeen2025-08-27-nux",NUX_2025_09_15:"viewed2025-09-15-nux",NUX_2025_09_15_FULL_CHATGPT_AUTH_VIEWED:"viewed2025-09-15-full-chatgpt-auth-nux",NUX_2025_09_15_APIKEY_AUTH_VIEWED:"viewed2025-09-15-apikey-auth-nux",WINDOWS_WSL_REMINDER_DISMISSED_AT:"windows-wsl-reminder-dismissed-date"};var vt=m(require("readline")),O=m(require("vscode")),yt="1";async function wt(s,e){let t=Ve(s),o=process.platform==="win32"?";":":",n=process.env.PATH+o+O.Uri.joinPath(s,oe()).fsPath,r=(0,gt.spawn)(t,["app-server"],{stdio:["pipe","pipe","pipe"],env:{...process.env,PATH:n,RUST_LOG:"warn",CODEX_INTERNAL_ORIGINATOR_OVERRIDE:he}});if(r.pid==null)throw new Error(`Failed to spawn codex mcp process at ${t}`);let i=new $e(r,e);{let a={id:yt,method:"initialize",params:{clientInfo:{name:us(),title:"Codex Extension",version:Be()}}};r.stdin.destroyed||r.stdin.write(JSON.stringify(a)+`
`)}return await i.whenInitialized,i}var $e=class{constructor(e,t){this.proc=e;this.userAgentProvider=t;e.on("error",o=>{d.error(`codex mcp process error: ${o}`)}),e.on("exit",(o,n)=>{o!==0?d.error(`codex mcp process exited with code ${o} and signal ${n}`):d.info("codex mcp process exited successfully.")}),e.stderr&&e.stderr.on("data",o=>{let n=ps(o.toString().trim());if(n){let{level:r,message:i}=ls(n),a="CLI:";switch(r){case"trace":case"debug":case"info":d.info(`${a} ${i}`);break;case"warn":d.warn(`${a} ${i}`);break;case"error":d.error(`${a} ${i}`);break}}}),this.whenInitialized=new Promise((o,n)=>{this.resolveInit=o,this.rejectInit=n}),this.rl=vt.createInterface({input:e.stdout}),this.rl.on("line",o=>{let n=o.trim(),r;try{r=JSON.parse(n)}catch(i){d.error(`unable to parse stdout from codex mcp: ${i}`);return}if(!this.initialized){if("id"in r&&("result"in r||"error"in r)&&r.id===yt){if("error"in r&&r.error){let i=new Error(`Failed to initialize local agent: ${JSON.stringify(r.error)}`);this.rejectInit?.(i)}else{let i=r.result;this.userAgentProvider.setUserAgent(i.userAgent??he),this.initialized=!0,this.resolveInit?.()}return}d.warn(`Dropping MCP message received before initialization: ${n}`);return}this.routeIncomingMessage(r)})}rl;providers=new Map;initialized=!1;whenInitialized;resolveInit;rejectInit;registerProvider(e,t){if(this.providers.has(e))throw new Error(`Provider already registered: ${e}`);return this.providers.set(e,t),new O.Disposable(()=>{this.providers.delete(e)})}sendRequest(e,t,o,n){let i={id:`${e}:${t}`,method:o,params:n};this.sendMessage(i)}sendNotification(e,t){let o={method:e,params:t};this.sendMessage(o)}sendResponse(e,t){let o={id:e,result:t};this.sendMessage(o)}sendMessage(e){let{stdin:t}=this.proc;t.destroyed||t.write(JSON.stringify(e)+`
`)}routeIncomingMessage(e){if(this.isMcpResponseMessage(e)){let t=e.id;if(typeof t=="string"&&t.includes(":")){let[o,...n]=t.split(":"),r=n.join(":"),i=this.providers.get(o);if(i?.onResult){let a={...e,id:r};i.onResult(a)}return}d.warn(`Received MCP response with id=${JSON.stringify(t)} but no provider namespace`);return}if(this.isMcpRequestMessage(e)){for(let[,t]of this.providers)t.onRequest?.(e);return}if(typeof e.method=="string"){let{method:t,params:o}=e;for(let[,n]of this.providers)n.onNotification?.({method:t,params:o});return}d.error(`Received unknown MCP message: ${JSON.stringify(e)}`)}isMcpResponseMessage(e){return"id"in e&&("result"in e||"error"in e)}isMcpRequestMessage(e){return typeof e.method=="string"&&"id"in e&&e.id!=null}dispose(){this.rl.close(),this.proc.kill()}};function Ve(s){let e=k().get(U.CLI_EXECUTABLE);if(e&&e.trim().length>0)return e;{let t=process.platform==="win32"?"codex.exe":"codex",o=oe();return O.Uri.joinPath(s,`${o}/${t}`).fsPath}}function ps(s){return s.replace(/\x1b\[[0-9;]*m/g,"")}function ls(s){let e=s.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z\s+(\w+)\s+(.+)$/);if(e){let t=e[1].toLowerCase();return t==="trace"||t==="debug"||t==="info"||t==="warn"||t==="error"?{level:t,message:e[2]}:{level:"error",message:e[2]}}return{level:"error",message:s}}function us(){let s=O.env.appName??"",e=s.toLowerCase();return e.includes("cursor")?"Cursor":e.includes("windsurf")?"Windsurf":e.includes("visual studio code")||e==="code"||e.startsWith("code ")||e.endsWith(" code")||e.includes("vscode")?"VS Code":s||"VS Code"}function Be(){let e=O.extensions.getExtension("openai.chatgpt")?.packageJSON?.version;return typeof e=="string"&&e.trim().length>0?e:"0.0.0"}var bt=m(require("os")),xt=m(require("path"));function ge(){return process.env.CODEX_HOME??xt.join(bt.homedir(),".codex")}R();var Ge=m(require("vscode"));async function D(){try{await Ge.commands.executeCommand("workbench.view.extension.codexViewContainer"),await Ge.commands.executeCommand(`${$.viewType}.focus`)}catch(s){d.error(`Failed to focus Codex view: ${s instanceof Error?s.message:String(s)}`)}}ue();R();var ve=require("fs"),Pt=m(require("path")),y=m(require("vscode")),fs=5173,ms=`http://localhost:${fs}`,hs="/src/main.tsx",$=class s{constructor(e,t,o,n){this.extensionUri=e;this.codexMcpConnection=t;this.fetchWrapper=o;this.ideContextConnection=n;this.subscriptions.push(y.commands.registerCommand("chatgpt.implementTodo",async({line:i,fileName:a,comment:c})=>{await D();let p={fileName:a,line:i,comment:c};this.sidebarView&&this.sidebarWebviewReady?this.postMessageToWebview(this.sidebarView.webview,{type:"implement-todo",...p}):this.pendingImplementTodo=p})),this.subscriptions.push(y.workspace.onDidChangeWorkspaceFolders(()=>{this.broadcastToAllViews({type:"workspace-roots-updated"})})),this.subscriptions.push(this.ideContextConnection.onIdeContextChange(()=>{this.broadcastToAllViews({type:"ide-context-updated"})}));let r=this.codexMcpConnection.registerProvider(s.providerName,{onResult:i=>{this.deliverMcpResponseToOrigin(i)},onRequest:i=>{this.broadcastToAllViews({type:"mcp-request",request:i})},onNotification:i=>{let{method:a,params:c}=i;this.broadcastToAllViews({type:"mcp-notification",method:a,params:c})}});this.subscriptions.push(r)}static viewType="chatgpt.sidebarView";static panelViewType="chatgpt.panelView";static providerName="webview";sidebarView;sidebarWebviewReady=!1;editorPanels=new Map;subscriptions=[];pendingImplementTodo=null;pendingContextFiles=[];pendingNavigationRoutes=[];pendingMcpRequests=new Map;focusedView;diffPanelsByConversation=new Map;diffPanelOwners=new Map;async resolveWebviewView(e,t,o){this.sidebarView=e;let{webview:n}=e;await this.initializeWebview(n,"sidebar"),this.subscriptions.push(e.onDidDispose(()=>{this.clearPendingMcpRequestsForWebview(n),this.sidebarView=void 0,this.sidebarWebviewReady=!1,this.disposeDiffPanelForWebview(n),this.focusedView?.kind==="sidebar"&&(this.focusedView=this.getActivePanelFocusedView()??void 0)})),this.subscriptions.push(e.onDidChangeVisibility(()=>{y.commands.executeCommand("setContext","chatgpt.sidebarView.visible",e.visible),!e.visible&&this.focusedView?.kind==="sidebar"&&(this.focusedView=this.getActivePanelFocusedView()??void 0)}))}triggerNewChatViaWebview(){this.sidebarView&&this.sidebarWebviewReady&&this.postMessageToWebview(this.sidebarView.webview,{type:"new-chat"})}postMessageToWebview(e,t){let o=JSON.stringify(t);e.postMessage(o)}addContextFile(e){let t={type:"add-context-file",file:e},o=this.focusedView;o?.kind==="panel"&&this.editorPanels.has(o.panel)?this.sendMessageToPanel(o.panel,t):this.sidebarView&&this.sidebarWebviewReady?this.postMessageToWebview(this.sidebarView.webview,t):this.pendingContextFiles.push(e)}navigateToRoute(e,t){let o={type:"navigate-to-route",path:e,state:t};this.sidebarView&&this.sidebarWebviewReady?this.postMessageToWebview(this.sidebarView.webview,o):this.pendingNavigationRoutes.push({path:e,state:t})}postMessageToSidebar(e){this.sidebarView&&this.postMessageToWebview(this.sidebarView.webview,e)}broadcastToAllViews(e){this.postMessageToSidebar(e),this.broadcastToPanels(e)}setFocusedViewForWebview(e){if(this.sidebarView?.webview===e){this.focusedView={kind:"sidebar"};return}let t=this.findPanelByWebview(e);if(t){if(this.diffPanelOwners.has(t))return;this.focusedView={kind:"panel",panel:t}}}findPanelByWebview(e){for(let t of this.editorPanels.keys())if(t.webview===e)return t}async initializeWebview(e,t,o){let n=y.Uri.joinPath(this.extensionUri,"webview");e.options={enableScripts:!0,enableCommandUris:!1,localResourceRoots:[n]};let r=e.onDidReceiveMessage(i=>{if(i.type==="ready"){if(t==="sidebar"){if(this.sidebarWebviewReady=!0,this.pendingImplementTodo&&(this.postMessageToWebview(e,{type:"implement-todo",...this.pendingImplementTodo}),this.pendingImplementTodo=null),this.pendingContextFiles.length>0){for(let a of this.pendingContextFiles)this.postMessageToWebview(e,{type:"add-context-file",file:a});this.pendingContextFiles=[]}if(this.pendingNavigationRoutes.length>0){for(let{path:a,state:c}of this.pendingNavigationRoutes)this.postMessageToWebview(e,{type:"navigate-to-route",path:a,state:c});this.pendingNavigationRoutes=[]}}o?.()}this.handleMessage(e,i)});this.subscriptions.push(r),e.html=await this.getWebviewContent(e)}sendMessageToPanel(e,t){let o=this.editorPanels.get(e);if(o)o.ready?this.postMessageToWebview(e.webview,t):o.pendingMessages.push(t);else return}broadcastToPanels(e){for(let[t,o]of this.editorPanels.entries()){if(!o.ready){o.pendingMessages.push(e);continue}this.postMessageToWebview(t.webview,e)}}getActivePanelFocusedView(){for(let e of this.editorPanels.keys())if(e.active)return{kind:"panel",panel:e}}getDiffPanelForWebview(e){let t=this.diffPanelsByConversation.get(e);if(t){if(!this.editorPanels.has(t)){this.diffPanelsByConversation.delete(e),this.diffPanelOwners.delete(t);return}return t}}async ensureDiffPanelForWebview(e,t){let o=this.getDiffPanelForWebview(e);if(o)return o;let n=await this.createEditorPanel({viewColumn:t?.viewColumn??y.ViewColumn.Active,title:"Codex Diff",mode:"diff",ownerWebview:e});return this.diffPanelsByConversation.set(e,n),this.diffPanelOwners.set(n,e),n}disposeDiffPanelForWebview(e){let t=this.diffPanelsByConversation.get(e);if(t){this.diffPanelsByConversation.delete(e),this.diffPanelOwners.delete(t);try{t.dispose()}catch{}}}async createEditorPanel(e){let t=e?.mode??"conversation",o=e?.ownerWebview;if(t==="diff"&&!o)throw new Error("ownerWebview is required for diff panels");let n=y.Uri.joinPath(this.extensionUri,"webview"),r=y.window.createWebviewPanel(s.panelViewType,e?.title??"Codex",{viewColumn:e?.viewColumn??y.window.activeTextEditor?.viewColumn??y.ViewColumn.Active,preserveFocus:e?.preserveFocus??!1},{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[n]});return this.editorPanels.set(r,{ready:!1,pendingMessages:[]}),this.subscriptions.push(r.onDidDispose(()=>{switch(this.clearPendingMcpRequestsForWebview(r.webview),this.editorPanels.delete(r),this.focusedView?.kind==="panel"&&this.focusedView.panel===r&&(this.focusedView=this.getActivePanelFocusedView()??(this.sidebarView?.visible?{kind:"sidebar"}:void 0)),t){case"diff":{o&&(this.diffPanelsByConversation.get(o)===r&&this.diffPanelsByConversation.delete(o),this.diffPanelOwners.delete(r));break}case"conversation":{this.disposeDiffPanelForWebview(r.webview);break}}})),await this.initializeWebview(r.webview,"panel",()=>{let i=this.editorPanels.get(r);if(!i)return;i.ready=!0;let a=i.pendingMessages;i.pendingMessages=[];for(let c of a)this.postMessageToWebview(r.webview,c)}),r}async ensurePrimaryEditorPanel(){let e=this.editorPanels.keys().next();return e.done?this.createEditorPanel():e.value}async handleMessage(e,t){switch(t.type){case"ready":break;case"view-focused":{this.setFocusedViewForWebview(e);break}case"mcp-request":{let{id:o,method:n,params:r}=t.request;this.pendingMcpRequests.set(String(o),e),this.codexMcpConnection.sendRequest(s.providerName,String(o),n,r);break}case"mcp-notification":{let{method:o,params:n}=t.request;this.codexMcpConnection.sendNotification(o,n);break}case"mcp-response":{let{id:o,result:n}=t.response;this.codexMcpConnection.sendResponse(o,n);break}case"open-in-browser":{y.env.openExternal(y.Uri.parse(t.url));break}case"open-extension-settings":{y.commands.executeCommand("workbench.action.openSettings","@ext:openai.chatgpt");break}case"open-keyboard-shortcuts":{y.commands.executeCommand("workbench.action.openGlobalKeybindings","chatgpt");break}case"open-config-toml":{let o=ge(),n=Pt.join(o,"config.toml");await ve.promises.mkdir(o,{recursive:!0});try{await ve.promises.access(n)}catch(r){let i=r;if("code"in i&&i.code==="ENOENT")await ve.promises.writeFile(n,"");else throw r}await y.commands.executeCommand("vscode.open",y.Uri.file(n));break}case"show-diff":{this.showDiff({unifiedDiff:t.unifiedDiff},e);break}case"update-diff-if-open":{let o=this.findPanelByWebview(e),n=o&&this.diffPanelOwners.has(o)?o:this.getDiffPanelForWebview(e);n&&this.sendMessageToPanel(n,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:t.unifiedDiff}});break}case"fetch":{let o=await this.fetchWrapper.fetch(t);this.postMessageToWebview(e,o);break}case"cancel-fetch":{this.fetchWrapper.cancel(t.requestId);break}case"fetch-stream":{this.fetchWrapper.stream(t,o=>{this.postMessageToWebview(e,o)});break}case"cancel-fetch-stream":{this.fetchWrapper.cancelStream(t.requestId);break}case"log-message":{let{level:o,message:n}=t;switch(o){case"trace":d.trace(n);break;case"debug":d.debug(n);break;case"info":d.info(n);break;case"warning":d.warn(n);break;case"error":d.error(n);break}break}}}async getWebviewContent(e){return this.getWebviewContentProduction(e)}async getWebviewContentProduction(e){let t=y.Uri.joinPath(this.extensionUri,"webview"),o=y.Uri.joinPath(t,"index.html"),n=await y.workspace.fs.readFile(o),r=new TextDecoder("utf-8").decode(n),i=e.asWebviewUri(t).toString()+"/",a=Ct(i),c=["default-src 'none'",`img-src ${e.cspSource} https: data: blob:`,`script-src ${e.cspSource}`,`style-src ${e.cspSource} 'unsafe-inline'`,`font-src ${e.cspSource}`,`connect-src ${e.cspSource}`].join("; ")+";",p=Ct(c);return r.replace("<!-- PROD_BASE_TAG_HERE -->",`<base href="${a}">`).replace("<!-- PROD_CSP_TAG_HERE -->",`<meta http-equiv="Content-Security-Policy" content="${p}">`)}getWebviewContentDevelopment(){return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="${y.Uri.parse(ms).toString()}">

    <!-- Hot reloading code from Vite -->
    <script type="module">
        import RefreshRuntime from "/@react-refresh"
        RefreshRuntime.injectIntoGlobalHook(window)
        window.$RefreshReg$ = () => {}
        window.$RefreshSig$ = () => (type) => type
        window.__vite_plugin_react_preamble_installed__ = true
    </script>
    <script type="module" src="/@vite/client"></script>
    <script type="module" src="${hs}"></script>
    <script src="http://localhost:8097"></script>
</head>
<body tabindex="0" style="outline: none">
    <div id="root"></div>
</body>
</html>`}dispose(){this.subscriptions.forEach(e=>e.dispose());for(let e of Array.from(this.diffPanelsByConversation.values()))try{e.dispose()}catch{}this.editorPanels.clear(),this.diffPanelsByConversation.clear(),this.diffPanelOwners.clear(),this.focusedView=void 0}async showDiff(e,t){let o=t??this.sidebarView?.webview;if(!o){let a=await this.ensurePrimaryEditorPanel(),c=await this.ensureDiffPanelForWebview(a.webview,a),p=c.viewColumn??a.viewColumn??y.ViewColumn.Active;c.reveal(p),this.sendMessageToPanel(c,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}});return}let n=this.findPanelByWebview(o),r=await this.ensureDiffPanelForWebview(o,n),i=r.viewColumn??n?.viewColumn??y.ViewColumn.Active;r.reveal(i),this.sendMessageToPanel(r,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}})}async createNewPanel(e){let t=await this.createEditorPanel(e),o=e?.viewColumn??t.viewColumn??y.ViewColumn.Active;t.reveal(o,e?.preserveFocus)}deliverMcpResponseToOrigin(e){let t=String(e.id),o=this.pendingMcpRequests.get(t);if(!o){d.warn(`Received MCP response for unknown request id: ${t}`);return}this.pendingMcpRequests.delete(t),this.postMessageToWebview(o,{type:"mcp-response",message:e})}clearPendingMcpRequestsForWebview(e){for(let[t,o]of this.pendingMcpRequests.entries())o===e&&this.pendingMcpRequests.delete(t)}};function Ct(s){return s.replace(/["<&]/g,e=>{switch(e){case'"':return"&quot;";case"<":return"&lt;";case"&":return"&amp;";default:return e}})}z();var ye=class{constructor(e,t=[],o=[],n){this.child=e;this.stdoutChunks=t;this.stderrChunks=o;this.promise=n.then(({code:r,signal:i})=>({type:"resolve",code:r,signal:i}),r=>({type:"reject",error:r}))}result=null;promise;check(){return this.wait().then(({stdout:e,stderr:t,code:o,signal:n})=>{if(o===0)return{stdout:e,stderr:t};throw new Error(`process exited with code ${o}, signal ${n}`)})}wait(){return this.promise.then(e=>{switch(e.type){case"resolve":{let{code:t,signal:o}=e;return{stdout:Buffer.concat(this.stdoutChunks).toString("utf8"),stderr:Buffer.concat(this.stderrChunks).toString("utf8"),code:t,signal:o}}case"reject":throw e.error}})}getStdout(){return Buffer.concat(this.stdoutChunks)}getStderr(){return Buffer.concat(this.stderrChunks)}getExitCode(){return this.result?.type==="resolve"?this.result.code:null}isDone(){return this.result!=null}kill(){this.child.kill()}};var Rt=require("child_process");function T({args:s,cwd:e}){let t=(0,Rt.spawn)(s[0],s.slice(1),{cwd:e,env:{...process.env},stdio:["ignore","pipe","pipe"]});if(!t.pid)throw new Error(`failed to start process from ${e}: \`${s.join(" ")}\``);let o=[],n=[],r=new Promise((i,a)=>{t.stdout?.on("data",c=>{o.push(c)}),t.stderr?.on("data",c=>{n.push(c)}),t.on("exit",(c,p)=>{i({code:c,signal:p})}),t.on("error",c=>{a(c)})});return new ye(t,o,n,r)}R();async function we(s){try{let e=T({args:["git","rev-parse","--show-toplevel"],cwd:s}),{stdout:t,code:o}=await e.wait();if(o===0)return t.trim()}catch{d.info(`getGitRoot: ${s} is not a git repository`)}return null}R();function St(s,e){let t=new Set,o=new Set,n=new Set,r=null,i=[s,e].filter(Boolean).join(`
`),a=(M,w)=>{let f=(w??"").trim();if(!f)return;let C=f.charAt(0),Ho=f.charAt(f.length-1),Le=f;(C==="'"||C==='"')&&Ho===C&&f.length>=2&&(Le=f.slice(1,-1)),Le&&M.add(Le)},c=(M,w)=>{for(let f of w)if(M[f])return M[f]},p=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+cleanly\.?)$/i,l=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with conflicts\.?)$/i,h=/^(?:Applying patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with\s+\d+\s+rejects?\.{0,3})$/i,u=/^(?:Checking patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\.\.\.)$/i,g=/^(?:Performing three-way merge|Falling back to three-way merge)\.\.\.$/i,v=/^Failed to perform three-way merge\.\.\.$/i,S=/^Falling back to direct application\.\.\.$/i,E=/^U\s+(?<path>.+)$/,Z=/^error:\s+patch failed:\s+(?<path>.+?)(?::\d+)?(?:\s|$)/i,de=/^error:\s+(?<path>.+?):\s+patch does not apply$/i,q=/^(?:error: )?repository lacks the necessary blob to (?:perform|fall back on) 3-?way merge\.?$/i,j=/^error:\s+(?<path>.+?):\s+does not match index\b/i,Fo=/^error:\s+(?<path>.+?):\s+does not exist in index\b/i,Wo=/^error:\s+(?<path>.+?)\s+already exists in (?:the )?working directory\b/i,_o=/^error:\s+patch failed:\s+(?<path>.+?)\s+File exists/i,Lo=/^error:\s+path\s+(?<path>.+?)\s+has been renamed\/deleted/i,qo=/^error:\s+cannot apply binary patch to\s+['"]?(?<path>.+?)['"]?\s+without full index line$/i,Uo=/^error:\s+binary patch does not apply to\s+['"]?(?<path>.+?)['"]?$/i,$o=/^error:\s+binary patch to\s+['"]?(?<path>.+?)['"]?\s+creates incorrect result\b/i,Vo=/^error:\s+cannot read the current contents of\s+['"]?(?<path>.+?)['"]?$/i,Bo=/^Skipped patch\s+['"]?(?<path>.+?)['"]\.$/i,Go=/^warning:\s*Cannot merge binary files:\s+(?<path>.+?)\s+\(ours\s+vs\.\s+theirs\)/i;for(let M of i.split(/\r?\n/)){let w=M.trim();if(!w)continue;let f;if(f=w.match(p)){let C=c(f.groups??{},["qpath","path"]);a(t,C),r=C??r,n.delete(C??""),o.delete(C??"");continue}if(f=w.match(l)){let C=c(f.groups??{},["qpath","path"]);a(n,C),r=C??r,t.delete(C??""),o.delete(C??"");continue}if(f=w.match(h)){let C=c(f.groups??{},["qpath","path"]);a(n,C),r=C??r,t.delete(C??""),o.delete(C??"");continue}if(f=w.match(E)){a(n,f.groups?.path),r=f.groups?.path??r,t.delete(f.groups?.path??""),o.delete(f.groups?.path??"");continue}if(f=w.match(u)){r=c(f.groups??{},["qpath","path"])??r;continue}if((f=w.match(Z))||(f=w.match(de))){a(o,f.groups?.path),r=f.groups?.path??r;continue}if(!(g.test(w)||S.test(w))){if(v.test(w)){r&&(a(o,r),t.delete(r),n.delete(r));continue}if(q.test(w)){r&&(a(o,r),t.delete(r),n.delete(r));continue}if((f=w.match(j))||(f=w.match(Fo))||(f=w.match(Wo))||(f=w.match(_o))||(f=w.match(Lo))||(f=w.match(qo))||(f=w.match(Uo))||(f=w.match($o))||(f=w.match(Vo))||(f=w.match(Bo))){a(o,f.groups?.path),r=f.groups?.path??r,t.delete(f.groups?.path??""),n.delete(f.groups?.path??"");continue}if(f=w.match(Go)){a(n,f.groups?.path),r=f.groups?.path??r,t.delete(f.groups?.path??""),o.delete(f.groups?.path??"");continue}}}for(let M of n)t.delete(M),o.delete(M);for(let M of t)o.delete(M);return{appliedPaths:Array.from(t).sort(),skippedPaths:Array.from(o).sort(),conflictedPaths:Array.from(n).sort()}}var F=m(require("fs/promises")),Et=m(require("os")),be=m(require("path"));async function kt({cwd:s,diff:e,revert:t}){let o=await we(s);if(!o)throw new Error(`${s} is not a git repository`);let n=await F.mkdtemp(be.join(Et.tmpdir(),"codex-apply-")),r=be.join(n,"patch.diff");await F.writeFile(r,e,"utf8"),t&&await gs(o,e);let i=["git","apply",t?"-R":null,"--3way",r].filter(Boolean),a=T({args:i,cwd:o}),{code:c,stdout:p,stderr:l}=await a.wait();d.info(`applyPatch revert: ${t}, code: ${c}, stdout: ${p}, stderr: ${l}`);let{appliedPaths:h,skippedPaths:u,conflictedPaths:g}=St(p,l);return await F.rm(n,{recursive:!0,force:!0}),{status:c===0?"success":c===1?"partial-success":"error",appliedPaths:h,skippedPaths:u,conflictedPaths:g}}async function gs(s,e){let t=vs(e),o=(await Promise.all(t.map(async n=>{try{return await F.access(be.join(s,n)),n}catch{return d.info(`Skipping staging ${n} because it does not exist in the working tree`),null}}))).filter(n=>!!n);if(o.length>0){let n=["git","add","--",...o],i=await T({args:n,cwd:s}).wait();d.info(`Staged ${o.length} files: ${i.code}`)}}function vs(s){let e=new Set,t=/^diff --git a\/(.*?) b\/(.*)$/gm,o;for(;(o=t.exec(s))!=null;){let[n,r,i]=o;r&&r!=="/dev/null"&&e.add(r),i&&i!=="/dev/null"&&e.add(i)}return Array.from(e)}z();R();R();var Tt=m(require("fs")),J=m(require("path")),V=m(require("vscode"));async function At(s,e=10){let t=V.workspace.workspaceFolders??[];if(s.trim().length===0||t.length===0)return[];let o=[],n=`**/*${ys(s)}*`,r=ws();for(let i of t){if(o.length>=e)break;try{let c=T({args:[r??"rg","--files","--iglob",n],cwd:i.uri.fsPath}),{stdout:p,code:l}=await c.wait();if(l!==0)return[];let h=p.split(/\r?\n/).map(u=>u.trim()).filter(Boolean);for(let u of h){if(o.length>=e)break;let g=J.isAbsolute(u)?u:J.join(i.uri.fsPath,u),v=J.basename(g).replace(/\\/g,"/"),S=V.workspace.asRelativePath(g).replace(/\\/g,"/");o.push({label:v,path:S,fsPath:g})}}catch(a){d.warn(`rg search failed in ${i.uri.fsPath}: ${String(a)}`)}}return o}function ys(s){let e=["*","?","[","]","{","}","!","\\"],t="";for(let o of s)t+=e.includes(o)?"\\"+o:o;return t}function ws(){try{let s=V.extensions.getExtension("openai.chatgpt");if(!s)return null;let e=process.platform==="win32"?"rg.exe":"rg",t=oe(),o=V.Uri.joinPath(s.extensionUri,t,e).fsPath;return Tt.existsSync(o)?o:null}catch{return null}}var Mt=require("child_process"),Ce=m(require("fs")),Pe=m(require("fs/promises")),Nt=m(require("os")),X=m(require("path")),bs=200*1024*1024;async function Ot(s,e){let t=xs(s),o=X.basename(t)||"repo";await Es(t,bs);let n=await xe(t,["rev-parse","HEAD"]),r=await xe(t,["rev-parse","--abbrev-ref","HEAD"]),i=r&&r!=="HEAD"?r:null,a=await xe(t,["remote","-v"]),c=Ss(a),p=`${o}-snapshot-${Date.now()}.tar.gz`,l=X.join(Nt.tmpdir(),p);if(e)await Ps(t,l,e);else{let u=await Cs(t);await Rs(t,l,u)}let h=await Pe.stat(l);return{tarballPath:l,tarballFilename:p,tarballSize:h.size,repoName:o,branch:i,snapshotBranch:e??i??n,commitSha:n,remotes:c,contentType:"application/gzip"}}async function Dt({tarballPath:s,uploadUrl:e,contentLength:t,contentType:o}){let n=Ce.createReadStream(s);try{let r=await fetch(e,{method:"PUT",headers:{"Content-Type":o,"Content-Length":t.toString(),"x-ms-blob-type":"BlockBlob"},body:n,duplex:"half"});if(!r.ok){let i=await r.text().catch(()=>"");throw new Error(`Snapshot upload failed with status ${r.status} ${r.statusText}${i?`: ${i}`:""}`)}}finally{n.destroy(),await Pe.unlink(s).catch(()=>{})}}function xs(s){let e=X.resolve(s);if(!Ce.existsSync(e))throw new Error(`Git root does not exist: ${e}`);return e}async function He(s,e){let t=T({args:["git",...e],cwd:s}),{stdout:o,stderr:n,code:r}=await t.wait();return{stdout:o,stderr:n,code:r}}async function xe(s,e){let{stdout:t,stderr:o,code:n}=await He(s,e);if(n!==0){let r=o.trim()||t.trim();throw new Error(`git ${e.join(" ")} failed${r?`: ${r}`:""}`)}return t.trim()}async function Cs(s){let{stdout:e,stderr:t,code:o}=await He(s,["ls-files","--cached","--others","--exclude-standard","-z"]);if(o!==0){let n=t.trim();throw new Error(`git ls-files failed${n?`: ${n}`:""}`)}return e?e.split("\0").map(n=>n.trim()).filter(n=>n.length>0):[]}async function Ps(s,e,t){await He(s,["archive","--format=tar.gz","-o",e,t])}async function Rs(s,e,t){await new Promise((o,n)=>{let i=(0,Mt.spawn)("tar",["--null","-czf",e,"-C",s,"--files-from","-"],{stdio:["pipe","ignore","pipe"]}),a="";if(i.stderr?.setEncoding("utf8"),i.stderr?.on("data",c=>{a+=c}),i.on("error",c=>n(c)),i.on("close",c=>{c===0?o():n(new Error(`tar exited with code ${c}${a?`: ${a.trim()}`:""}`))}),i.stdin){if(t.length>0){let c=`${t.join("\0")}\0`;i.stdin.write(c,"utf8",p=>{p&&n(p)})}i.stdin.end()}})}function Ss(s){let e={};for(let t of s.split(/\r?\n/)){let o=t.trim();if(!o)continue;let n=o.split(/\s+/);if(n.length<3)continue;let[r,i,a]=n;a==="(push)"&&e[r]==null&&(e[r]=i)}return e}async function Es(s,e){let t=await xe(s,["count-objects","-v"]),o=ks(t),r=((o.get("size")??0)+(o.get("size-pack")??0))*1024;if(r>e)throw new Error(`Repository is too large (${It(r)}). Maximum allowed size is ${It(e)}.`)}function ks(s){let e=new Map;for(let t of s.split(/\r?\n/)){let o=t.trim();if(!o)continue;let[n,r]=o.split(":");if(!n||r==null)continue;let i=Number.parseInt(r.trim(),10);Number.isFinite(i)&&e.set(n,i)}return e}function It(s){if(s<1024)return`${s} B`;let e=["KB","MB","GB","TB"],t=s/1024,o=0;for(;t>=1024&&o<e.length-1;)t/=1024,o+=1;return`${t.toFixed(1)} ${e[o]}`}var Ft=require("node:child_process"),ne=m(require("os")),Wt=m(require("path"));var b=m(require("vscode")),Ts=[{command:"wsl.exe",args:["--status"]}];function As(s){if(s!=="win32")return!1;for(let{command:e,args:t}of Ts)try{let o=(0,Ft.spawnSync)(e,t,{windowsHide:!0,stdio:"ignore"});if(o.error){if(o.error?.code==="ENOENT")return!1;continue}if(o.status===0)return!0}catch(o){if(o?.code==="ENOENT")return!1}return!1}var Re=class{constructor(e,t,o){this.authProvider=e;this.ideContextConnection=t;this.globalState=o}handlers={"workspace-roots":async()=>({roots:b.workspace.workspaceFolders?.map(e=>e.uri.fsPath)??[]}),"has-custom-cli-executable":async()=>({hasCustomCliExecutable:(k().get(U.CLI_EXECUTABLE)??"").trim().length>0}),"account-info":async()=>{let e=await this.authProvider.getToken({refreshToken:!1});if(!e)return{accountId:null,userId:null,plan:null,email:null};try{let t=JSON.parse(Buffer.from(e.split(".")[1],"base64url").toString("utf8")),o=t["https://api.openai.com/auth"]??{},n=t["https://api.openai.com/profile"]??{},r=o?.chatgpt_account_id??null,i=o?.chatgpt_user_id??null,a=o?.chatgpt_plan_type??null,c=n.email??null;if(r&&i&&a)return{accountId:r,userId:i,plan:a,email:c}}catch{d.error("Unable to extract account id and plan from auth token.")}return{accountId:null,userId:null,plan:null,email:null}},"extension-info":async()=>({version:Be()}),"os-info":async()=>{let e=ne.platform();return{platform:e,hasWsl:As(e)}},"openai-api-key":async()=>({value:process.env.OPENAI_API_KEY??null}),"find-files":async({query:e})=>({files:await At(e,10)??[]}),"ide-context":async()=>({ideContext:this.ideContextConnection.getIdeContext()}),"apply-patch":async e=>kt(e),"open-file":async({path:e,line:t,column:o})=>{let n=typeof t=="number"?t:void 0,r=typeof o=="number"?o:1,i=e.replace(/^([ab])[\\/]/,""),a=b.workspace.workspaceFolders??[],c=async h=>{try{let u=await b.workspace.openTextDocument(h),g=n!=null?new b.Range(new b.Position(Math.max(0,n-1),Math.max(0,r-1)),new b.Position(Math.max(0,n-1),Math.max(0,r-1))):void 0;return await b.window.showTextDocument(u,g?{preview:!1,selection:g}:void 0),!0}catch{return!1}};if(Wt.isAbsolute(i)){let h=await c(b.Uri.file(i));return h||d.error(`Failed to open absolute path: ${i}`),{success:h}}let p=i.split(/[\\/]+/).filter(Boolean),l=!1;for(let h of a){if(l)break;let u=b.Uri.joinPath(h.uri,...p);if(await c(u)){l=!0;break}let g=p.indexOf(h.name);if(g!==-1){let v=b.Uri.joinPath(h.uri,...p.slice(g+1));if(await c(v)){l=!0;break}}}if(!l&&i.length>0)try{let h=`**/${i.replace(/\\/g,"/")}`,u=await b.workspace.findFiles(h,void 0,1);u.length>0&&(l=await c(u[0]))}catch{}if(!l){let h=a.map(u=>u.uri.fsPath).join(", ");d.error(`Failed to resolve and open file from path "${e}" (normalized: "${i}") in workspaces: [${h}]`)}return{success:l}},"git-origins":async()=>{let e=b.workspace.workspaceFolders??[],t=[],o=new Set,n=ne.homedir();return await Promise.all(e.map(async r=>{let i=r.uri.fsPath;try{let a=T({args:["git","rev-parse","--show-toplevel"],cwd:r.uri.fsPath}),{stdout:c,code:p}=await a.wait();p===0&&(i=c.trim())}catch{}try{let a=T({args:["git","config","--get","remote.origin.url"],cwd:i}),{stdout:c,code:p}=await a.wait(),l=p===0?c.trim():null;o.has(i)||(t.push({root:i,originUrl:l}),o.add(i))}catch{o.has(i)||(t.push({root:i,originUrl:null}),o.add(i))}})),{origins:t,homeDir:n}},"git-roots":async()=>{let e=b.workspace.workspaceFolders??[],t=ne.homedir();return{roots:(await Promise.all(e.map(n=>we(n.uri.fsPath)))).filter(n=>n!=null),homeDir:t}},"git-current-branch":async({gitRoot:e})=>{let t=b.workspace.workspaceFolders??[],o=e??t[0]?.uri.fsPath;if(!o)return{branch:null};try{let n=T({args:["git","rev-parse","--abbrev-ref","HEAD"],cwd:o}),{stdout:r,code:i}=await n.wait();if(i===0){let a=r.trim();return{branch:a&&a!=="HEAD"?a:null}}}catch{}return{branch:null}},"prepare-worktree-snapshot":async({gitRoot:e,snapshotBranch:t})=>Ot(e,t),"upload-worktree-snapshot":async({tarballPath:e,uploadUrl:t,contentLength:o,contentType:n})=>{try{await Dt({tarballPath:e,uploadUrl:t,contentLength:o,contentType:n})}catch(r){return d.error(`Failed to upload worktree snapshot: ${r}`),{success:!1}}return{success:!0}},"get-configuration":async({key:e})=>({value:k().get(e)}),"set-configuration":async({key:e,value:t})=>(await k().update(e,t),{success:!0}),"get-global-state":async({key:e})=>({value:await this.globalState.get(e)}),"set-global-state":async({key:e,value:t})=>{try{return await this.globalState.update(e,t),{success:!0}}catch{return{success:!1}}},"set-vs-context":async({key:e,value:t})=>(await b.commands.executeCommand("setContext",e,t),{success:!0})};handleVSCodeRequest(e,t){return this.handlers[e](t)}};R();var _t=m(require("fs/promises")),Lt=m(require("path"));var Se=class{constructor(e){this.context=e}async get(e){let t=this.context.globalState.get(e);if(e===se.HAS_PROBABLY_SEEN_2025_08_27_NUX&&t==null){let o=ge(),n=Lt.join(o,"sessions"),r;try{r=(await _t.stat(n)).isDirectory(),r&&this.update(se.HAS_PROBABLY_SEEN_2025_08_27_NUX,!0)}catch{r=!1}return r}return t}async update(e,t){await this.context.globalState.update(e,t)}async dumpNuxState(){let e=Object.entries(se);for(let[t,o]of e){let n=this.context.globalState.get(o);d.info(`Global state ${t} (${o}): ${n}`)}}async resetNuxState(){d.info("Resetting NUX state"),await Promise.all(Object.values(se).map(e=>this.context.globalState.update(e,void 0)))}};var N=m(require("vscode"));function Is(s){return s.path.split("/").pop()??""}function je(){return N.window.tabGroups.all.flatMap(s=>s.tabs.filter(e=>e.input?.uri?.scheme==="file").map(e=>({label:e.label,path:N.workspace.asRelativePath(e.input?.uri?.fsPath),fsPath:e.input?.uri?.fsPath})))}function ze(s){return{label:Is(s.document.uri),path:N.workspace.asRelativePath(s.document.uri.fsPath),fsPath:s.document.uri.fsPath,selection:s.selection,activeSelectionContent:s.document.getText(s.selection),selections:s.selections.map(e=>({start:e.start,end:e.end}))}}var Ee=class{onIdeContextChangeEmitter=new N.EventEmitter;listeners=[];ideContext={activeFile:void 0,openTabs:[]};constructor(){this.listeners.push(N.window.onDidChangeActiveTextEditor(e=>this.onChangeActiveTextEditor(e))),this.listeners.push(N.window.onDidChangeTextEditorSelection(e=>{this.onChangeTextEditorSelection(e)})),this.initIdeContext()}get onIdeContextChange(){return this.onIdeContextChangeEmitter.event}getIdeContext(){return this.ideContext}initIdeContext(){let e=N.window.activeTextEditor;this.ideContext={activeFile:e?ze(e):void 0,openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeActiveTextEditor(e){this.ideContext={...this.ideContext,activeFile:e?ze(e):void 0,openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeTextEditorSelection(e){e.textEditor.document.uri.scheme==="file"&&(this.ideContext={...this.ideContext,activeFile:ze(e.textEditor),openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext))}dispose(){this.listeners.forEach(e=>e.dispose())}};R();var qt=m(require("vscode"));function Ut(s){let e=Ve(s),t=qt.window.createTerminal("Codex");t.show(),t.sendText(e)}var Ke=m(require("vscode")),ke=class{shellIntegrationSubscription;pendingTerminals=new Map;constructor(){this.shellIntegrationSubscription=Ke.window.onDidChangeTerminalShellIntegration(e=>{let{terminal:t}=e,o=this.pendingTerminals.get(t);o&&(o(t),this.pendingTerminals.delete(t))})}createTerminal(e){let t=Ke.window.createTerminal(e);return new Promise(o=>{this.pendingTerminals.set(t,o)})}dispose(){this.shellIntegrationSubscription.dispose()}};function Vt(s){let e=[],t=s.length,o=0;function n(a,c){let p=s[a],l=c;for(;l<t&&s[l]===p;)l++;let h=Te(s,l),u=$t(s,h,"TODO",!0),g=h;for(;g<t&&s[g]!==`
`&&s[g]!=="\r";)g++;if(u!==-1){let v=s.slice(u,g);e.push({body:v.trimEnd(),index:a})}return g}let r=null,i=!1;for(;o<t;){let a=s[o];if(r){i?i=!1:a==="\\"?i=!0:a===r&&(r=null),o++;continue}else if(a==='"'||a==="'"||a==="`"){r=a,o++;continue}if(a==="/"&&o+1<t){let c=s[o+1];if(c==="/"){o=n(o,o+2);continue}if(c==="*"){let p=o,l=o+2,h=s.indexOf("*/",l),u=h===-1?t:h+2,g=s.slice(l,h===-1?t:h);g=g.replace(/^(?:[ \t]*\*?[ \t]*(?:\r?\n|$))+/,"");let v=Te(g,0);g[v]==="*"&&(v=Te(g,v+1));let S=$t(g,v,"TODO",!0);if(S!==-1){let E=g.slice(S);e.push({body:E.replace(/\s+$/,""),index:p})}o=u;continue}}else if(a==="#"){o=n(o,o+1);continue}else if(a==="-"&&o+1<t&&s[o+1]==="-"){o=n(o,o+2);continue}o++}return e}function Ms(s){return s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||s===95}function Te(s,e){let t=e;for(;t<s.length;){let o=s.charCodeAt(t);if(o!==32&&o!==9)break;t++}return t}function $t(s,e,t,o=!0){let n=s.slice(e,e+t.length),r=o?t.toUpperCase():t;if((o?n.toUpperCase():n)!==r)return-1;let i=s.charCodeAt(e+t.length);if(Ms(i))return-1;let a=e+t.length;return(s[a]===":"||s[a]==="-")&&a++,a=Te(s,a),a}var Ie=m(require("vscode")),Ae=class{provideCodeLenses(e,t){let o=e.getText(),n=[];for(let{index:r,body:i}of Vt(o)){if(t?.isCancellationRequested)break;let a=e.positionAt(r),c=new Ie.Range(a,a);n.push(new Ie.CodeLens(c,{title:"Implement with Codex",command:"chatgpt.implementTodo",arguments:[{fileName:encodeURIComponent(e.uri.fsPath),line:a.line+1,comment:i}]}))}return n}};R();var Me=class{constructor(e){this.codexWebviewProvider=e}async handleUri(e){d.info({event:"handleUri",path:e.path});try{await D();let t=e.path||"/";this.codexWebviewProvider.navigateToRoute(t)}catch(t){d.error(`Failed to handle URI ${e.toString()}: ${t instanceof Error?t.message:String(t)}`)}}};var Ne=class{userAgent=null;getUserAgent(){return this.userAgent}setUserAgent(e){this.userAgent=e}};var I=m(require("vscode")),Vs="chatgpt.newChat";async function Bs(s){let{subscriptions:e}=s;e.push(d),d.info("Activating Codex extension");let t=new ke;e.push(t);let o=new Ne,n=await wt(s.extensionUri,o);e.push(n);let r=at(n),i=new Se(s),a=new Ee;e.push(a);let c=new Re(r,a,i),p=new me(r,c,o),l=new $(s.extensionUri,n,p,a);e.push(l);let h=new Me(l);if(e.push(I.window.registerUriHandler(h)),e.push(I.window.registerWebviewViewProvider($.viewType,l,{webviewOptions:{retainContextWhenHidden:!0}})),e.push(I.commands.registerCommand("chatgpt.openSidebar",D)),e.push(I.commands.registerCommand("chatgpt.newCodexPanel",()=>l.createNewPanel())),e.push(I.commands.registerCommand("chatgpt.addToThread",async()=>rt(l))),e.push(I.commands.registerCommand(Vs,async()=>{await D(),l.triggerNewChatViaWebview()})),e.push(I.commands.registerCommand("chatgpt.runCodexInTerminal",()=>Ut(s.extensionUri))),k().get(U.COMMENT_CODELENS_ENABLED,!0)){let v=new Ae,S=[{scheme:"file"},{scheme:"untitled"}];e.push(I.languages.registerCodeLensProvider(S,v))}k().get(U.OPEN_ON_STARTUP,!1)&&D(),e.push(I.commands.registerCommand("chatgpt.dumpNuxState",()=>{i.dumpNuxState()}),I.commands.registerCommand("chatgpt.resetNuxState",()=>{i.resetNuxState()})),process.platform==="darwin"&&(async()=>{try{let v=await Promise.resolve().then(()=>(Do(),Oo));typeof v.activate=="function"&&(v.activate(s),d.info("Work with apps desktop bridge initialized"))}catch(v){d.warn("Desktop bridge init failed: "+(v instanceof Error?v.message:String(v)))}})()}0&&(module.exports={activate});
