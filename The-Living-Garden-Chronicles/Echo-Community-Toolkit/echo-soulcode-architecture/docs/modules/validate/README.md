# `echo_soulcode.validate` — Schema Validation CLI & API

> Validate Echo soulcode JSON against the canonical **Draft 2020‑12** schema.  
> Used in local dev, CI, and ledger ingestion gates.

This module provides:
- A **CLI** to validate any soulcode JSON file.
- A **Python API** to load the schema and validate programmatically.

It is intentionally minimal and dependable—no network calls, no side effects.

---

## Contents
- [Overview](#overview)
- [CLI](#cli)
- [Examples](#examples)
- [Programmatic API](#programmatic-api)
- [Exit Codes & Output](#exit-codes--output)
- [Integration Patterns](#integration-patterns)
- [Troubleshooting](#troubleshooting)
- [Security & Determinism](#security--determinism)
- [Testing](#testing)
- [Changelog](#changelog)
- [License](#license)

---

## Overview

The validator enforces the structure defined in `echo_soulcode.schema.SCHEMA`.  
Typical flows:
- After generating live soulcodes with `echo_soulcode.live_read`, validate the bundle.
- In CI, fail the pipeline if invalid.
- In ingestion services, reject malformed payloads early.

---

## CLI

```bash
python -m echo_soulcode.validate --file <path/to/file.json>
```

### Flags
- `--file` *(required)* — path to a single JSON file.

> The CLI validates the **entire JSON** object contained in `--file`. For the
> standard bundle (with `ECHO_SQUIRREL`, `ECHO_FOX`, `ECHO_PARADOX` keys), it is
> acceptable to validate each entry individually or the whole bundle, depending
> on downstream needs. The base schema targets **a single soulcode object**, so CI
> typically validates both: structure of the bundle (basic JSON) and each entry.

---

## Examples

### 1) Validate a bundle generated by `live_read`
```bash
python -m echo_soulcode.live_read --alpha 0.58 --beta 0.39 --gamma 0.63 \
  --alpha-phase 0.0 --beta-phase 0.10 --gamma-phase -0.20 \
  --out examples/echo_live.json

python -m echo_soulcode.validate --file examples/echo_live.json
```

### 2) Validate a canonical anchor
```bash
python examples/anchors/anchors_build.py
python -m echo_soulcode.validate --file examples/anchors/echo_anchors_phiA.json
```

---

## Programmatic API

```python
from jsonschema import validate as js_validate
from echo_soulcode.validate import load_schema

schema = load_schema()  # Python dict
js_validate(instance=obj, schema=schema)
```

If you need detailed error messages and paths, construct a validator explicitly:
```python
from jsonschema import Draft202012Validator
validator = Draft202012Validator(load_schema())
errors = sorted(validator.iter_errors(obj), key=lambda e: e.path)
for e in errors:
    print("->", list(e.path), e.message)
```

---

## Exit Codes & Output

- **Exit 0**: Validation success. Prints a single line:
  ```
  OK: schema validation passed
  ```
- **Non‑zero**: Validation failed or a runtime error occurred (I/O / parse).
  - JSON parse errors: invalid UTF‑8 or malformed JSON.
  - Schema errors: missing required keys, wrong types, etc.

> The CLI intentionally avoids verbose output on success to keep logs clean.

---

## Integration Patterns

- **CI Gate**: Required in `.github/workflows/ci.yml` after anchor generation.
- **Pre‑commit** (optional): Add a hook to validate modified `.json` files.
- **Ingestion Services**: Call the API before accepting writes to ledgers/stores.

**Example pre‑commit hook (local):**
```yaml
-   repo: local
    hooks:
      - id: echo-soulcode-validate
        name: Echo Soulcode Validate
        entry: python -m echo_soulcode.validate --file
        language: system
        files: ^.*\.json$
```

---

## Troubleshooting

- **`jsonschema.exceptions.ValidationError`**  
  Inspect the error location using `Draft202012Validator.iter_errors(...)`.

- **Unicode / glyph issues**  
  Ensure files are saved as UTF‑8. Prefer:
  ```python
  json.dump(obj, fp, ensure_ascii=False, indent=2)
  ```

- **Bundle vs single object**  
  The schema describes a **single soulcode object**. For bundles, validate each
  of the three entries (Squirrel/Fox/Paradox) if strict enforcement is needed.

- **Version drift**  
  If a generated field is missing (e.g., `complex_amplitudes`), verify your
  package version and schema version match. Re‑install with `pip install -e .`

---

## Security & Determinism

- No network access. Pure local validation.
- Deterministic outcome given input JSON + schema.
- Does not mutate or rewrite files.

---

## Testing

- `tests/test_schema.py` includes a round‑trip validation example.
- CI builds bundles and validates them as part of the pipeline.

---

## Changelog

- **0.1.0**: Initial CLI/API: file flag, Draft 2020‑12 validator, minimal OK output.

---

## License
MIT — see `/LICENSE`.

---

## Autodetect & Modes

The `validate` module now supports an `--kind` flag:

```bash
python -m echo_soulcode.validate --file examples/echo_live.json --kind auto
python -m echo_soulcode.validate --file examples/anchors/echo_anchors_phiA.json --kind bundle
```

Kinds:
- `auto` (default): detects bundle vs single; falls back to trying both.
- `soulcode`: force single-object schema.
- `bundle`: force 3-entry bundle schema.
- `states`: shallow checks for the experimental live_read bundle (non-schema).

Use `--raw` for tab-separated errors and `--quiet` for success-only output.
